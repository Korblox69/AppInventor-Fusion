<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fusionador d'App Inventor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .project-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .merge-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
        }
        .file-input {
            margin-bottom: 15px;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            color: #666;
        }
        .checklist {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
    </style>
</head>
<body class="container py-4">
    <h1 class="text-center mb-4">Fusionador de Projectes App Inventor</h1>
    
    <div class="row">
        <div class="col-md-6">
            <div class="project-card">
                <h3>Projecte Principal</h3>
                <input type="file" class="form-control file-input" id="mainProject" accept=".aia">
                <div id="mainScreens" class="checklist mt-3"></div>
                <div id="mainAssets" class="checklist mt-3"></div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="project-card">
                <h3>Projecte Secundari</h3>
                <input type="file" class="form-control file-input" id="secondProject" accept=".aia">
                <div id="secondScreens" class="checklist mt-3"></div>
                <div id="secondAssets" class="checklist mt-3"></div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12 text-center">
            <button class="btn btn-success merge-btn" onclick="mergeProjects()">
                Fusionar Projectes
            </button>
        </div>
    </div>

    <div class="footer">
        <p>Fet per SirHumza | 
            <a href="https://github.com/SirHumza/AppInventor-Fusion" target="_blank">
                Codi a GitHub
            </a>
        </p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script>
        let mainProject = {screens: [], assets: []};
        let secondProject = {screens: [], assets: []};
        let screenRenames = new Map();

        // Carregar projecte principal
        document.getElementById('mainProject').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            mainProject = await processAIA(file);
            updateChecklist('mainScreens', mainProject.screens, 'screen');
            updateChecklist('mainAssets', mainProject.assets, 'asset');
        });

        // Carregar projecte secundari
        document.getElementById('secondProject').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            secondProject = await processAIA(file);
            updateChecklist('secondScreens', secondProject.screens, 'screen');
            updateChecklist('secondAssets', secondProject.assets, 'asset');
        });

        async function processAIA(file) {
            const project = {screens: [], assets: []};
            const zip = await JSZip.loadAsync(file);
            
            zip.forEach((relativePath, zipEntry) => {
                if (relativePath.startsWith('src/') && relativePath.endsWith('.scm')) {
                    const screenName = relativePath.split('/').pop().replace('.scm', '');
                    project.screens.push({
                        name: screenName,
                        scmPath: relativePath,
                        bkyPath: relativePath.replace('.scm', '.bky')
                    });
                } else if (relativePath.startsWith('assets/')) {
                    project.assets.push({
                        name: zipEntry.name.split('/').pop(),
                        path: relativePath
                    });
                }
            });

            return project;
        }

        function updateChecklist(containerId, items, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(item => `
                <div class="form-check">
                    <input class="form-check-input ${type}-check" type="checkbox" 
                           id="${item.name}" data-path="${item.path}" checked>
                    <label class="form-check-label" for="${item.name}">
                        ${item.name}${type === 'screen' ? ' (Pantalla)' : ''}
                    </label>
                </div>
            `).join('');
        }

        async function mergeProjects() {
            // Comprovar conflictes
            const allScreens = [...mainProject.screens, ...secondProject.screens];
            const screenNames = allScreens.map(s => s.name);
            const duplicates = screenNames.filter((name, index) => screenNames.indexOf(name) !== index);
            
            // Gestionar Screen1 duplicat
            if (duplicates.includes('Screen1')) {
                const newName = prompt('Introdueix un nou nom per a Screen1 del segon projecte:');
                if (newName) screenRenames.set('Screen1', newName);
            }

            // Crear ZIP fusionat
            const mergedZip = new JSZip();
            
            // Afegir fitxers de projecte
            mergedZip.file("youngandroidproject/project.properties", 
                `#Project properties\nname=ProjecteFusionat\n`);
            
            // Processar pantalles
            await processProject(mainProject, mergedZip);
            await processProject(secondProject, mergedZip);

            // Generar i descarregar
            const content = await mergedZip.generateAsync({type: "blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `projecte_fusionat_${Date.now()}.aia`;
            link.click();
        }

        async function processProject(project, zip) {
            // Processar pantalles seleccionades
            document.querySelectorAll('.screen-check:checked').forEach(checkbox => {
                const screen = project.screens.find(s => s.name === checkbox.id);
                if (screen) {
                    zip.file(screen.scmPath, getFileContent(project.zip, screen.scmPath));
                    zip.file(screen.bkyPath, getFileContent(project.zip, screen.bkyPath));
                }
            });

            // Processar recursos seleccionats
            document.querySelectorAll('.asset-check:checked').forEach(checkbox => {
                const asset = project.assets.find(a => a.name === checkbox.id);
                if (asset) {
                    zip.file(asset.path, getFileContent(project.zip, asset.path));
                }
            });
        }

        async function getFileContent(zip, path) {
            const file = zip.file(path);
            return file ? await file.async('uint8array') : null;
        }
    </script>
</body>
</html>
